const API = { clientes: '/api/clientes', mascotas: '/api/mascotas', vets: '/api/veterinarios', citas: '/api/citas' };
function $(id){return document.getElementById(id);} 
async function fetchJson(url, opts){ const res = await fetch(url, opts); if(!res.ok) throw new Error('Error '+res.status); return res.json(); }
function renderRows(tableId, list, mapper){ const tbody = $(tableId).querySelector('tbody'); tbody.innerHTML = list.map(mapper).join(''); }
async function loadAll(){ try{ const [clientes, mascotas, vets, citas] = await Promise.all([fetchJson(API.clientes), fetchJson(API.mascotas), fetchJson(API.vets), fetchJson(API.citas)]); window._clientes = clientes; window._mascotas = mascotas; window._vets = vets; window._citas = citas; renderClientes(clientes); renderMascotas(mascotas); renderVets(vets); renderCitas(citas); fillClienteSelects(clientes); $('cita_vet').innerHTML = '<option value="">Seleccione</option>' + vets.map(v=>`<option value="${v.id}">${v.nombre}</option>`).join(''); }catch(e){ console.error(e); }}
function renderClientes(list){ renderRows('tablaClientes', list, (c,i)=>`<tr><td>${i+1}</td><td>${c.nombre}</td><td>${c.telefono||''}</td><td>${c.correo||''}</td><td><button class="btn btn-sm btn-success" onclick="editCliente(${c.id})">Editar</button> <button class="btn btn-sm btn-danger" onclick="delCliente(${c.id})">Eliminar</button></td></tr>`); }
function renderMascotas(list){ renderRows('tablaMascotas', list, (m,i)=>`<tr><td>${i+1}</td><td>${m.nombre}</td><td>${m.especie}</td><td>${m.raza||''}</td><td>${m.edad||''}</td><td>${m.cliente||''}</td><td><button class="btn btn-sm btn-success" onclick="editMascota(${m.id})">Editar</button> <button class="btn btn-sm btn-danger" onclick="delMascota(${m.id})">Eliminar</button></td></tr>`); }
function renderVets(list){ renderRows('tablaVets', list, (v,i)=>`<tr><td>${i+1}</td><td>${v.nombre}</td><td>${v.especialidad||''}</td><td><button class="btn btn-sm btn-success" onclick="editVet(${v.id})">Editar</button> <button class="btn btn-sm btn-danger" onclick="delVet(${v.id})">Eliminar</button></td></tr>`); }
function renderCitas(list){ renderRows('tablaCitas', list, (c,i)=>`<tr><td>${i+1}</td><td>${c.fecha}</td><td>${c.hora}</td><td>${c.mascota||''}</td><td>${c.especie||''}</td><td>${c.cliente||''}</td><td>${c.veterinario||''}</td><td>${c.motivo||''}</td><td><button class="btn btn-sm btn-success" onclick="editCita(${c.id})">Editar</button> <button class="btn btn-sm btn-danger" onclick="delCita(${c.id})">Eliminar</button></td></tr>`); }
function fillClienteSelects(clientes){ const opts = '<option value="">Seleccione</option>' + clientes.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join(''); $('cita_cliente').innerHTML = opts; $('mascota_cliente').innerHTML = opts; $('filtroClienteMas').innerHTML = '<option value="">Filtrar por cliente</option>' + clientes.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join(''); }
$('btnAddCliente').addEventListener('click', ()=>{ $('cliente_id').value=''; $('cliente_nombre').value=''; $('cliente_telefono').value=''; $('cliente_correo').value=''; new bootstrap.Modal($('modalCliente')).show(); });
$('saveCliente').addEventListener('click', async ()=>{ const id = $('cliente_id').value; const payload = { nombre: $('cliente_nombre').value, telefono: $('cliente_telefono').value, correo: $('cliente_correo').value }; try{ if(id){ await fetchJson(API.clientes+'/'+id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } else { await fetchJson(API.clientes, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } new bootstrap.Modal($('modalCliente')).hide(); await loadAll(); }catch(e){ alert('Error guardando cliente'); } });
window.editCliente = async (id)=>{ const c = window._clientes.find(x=>x.id==id); if(!c) return; $('cliente_id').value=c.id; $('cliente_nombre').value=c.nombre; $('cliente_telefono').value=c.telefono; $('cliente_correo').value=c.correo; new bootstrap.Modal($('modalCliente')).show(); }
window.delCliente = async (id)=>{ if(!confirm('Eliminar cliente?')) return; await fetchJson(API.clientes+'/'+id, { method:'DELETE' }); await loadAll(); }
$('btnAddMascota').addEventListener('click', ()=>{ $('mascota_id').value=''; $('mascota_nombre').value=''; $('mascota_especie').value=''; $('mascota_raza').value=''; $('mascota_edad').value=''; new bootstrap.Modal($('modalMascota')).show(); });
$('saveMascota').addEventListener('click', async ()=>{ const id = $('mascota_id').value; const payload = { nombre:$('mascota_nombre').value, especie:$('mascota_especie').value, raza:$('mascota_raza').value, edad: parseInt($('mascota_edad').value)||0, id_cliente: $('mascota_cliente').value }; try{ if(id){ await fetchJson(API.mascotas+'/'+id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } else { await fetchJson(API.mascotas, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } new bootstrap.Modal($('modalMascota')).hide(); await loadAll(); }catch(e){ alert('Error guardando mascota'); } });
window.editMascota = async (id)=>{ const m = window._mascotas.find(x=>x.id==id); if(!m) return; $('mascota_id').value=m.id; $('mascota_nombre').value=m.nombre; $('mascota_especie').value=m.especie; $('mascota_raza').value=m.raza; $('mascota_edad').value=m.edad; $('mascota_cliente').value=m.id_cliente; new bootstrap.Modal($('modalMascota')).show(); }
window.delMascota = async (id)=>{ if(!confirm('Eliminar mascota?')) return; await fetchJson(API.mascotas+'/'+id, { method:'DELETE' }); await loadAll(); }
$('btnAddVet').addEventListener('click', ()=>{ $('vet_id').value=''; $('vet_nombre').value=''; $('vet_especialidad').value=''; new bootstrap.Modal($('modalVet')).show(); });
$('saveVet').addEventListener('click', async ()=>{ const id=$('vet_id').value; const payload={ nombre:$('vet_nombre').value, especialidad:$('vet_especialidad').value }; try{ if(id){ await fetchJson(API.vets+'/'+id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } else { await fetchJson(API.vets, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } new bootstrap.Modal($('modalVet')).hide(); await loadAll(); }catch(e){ alert('Error guardando veterinario'); } });
window.editVet = async (id)=>{ const v = window._vets.find(x=>x.id==id); if(!v) return; $('vet_id').value=v.id; $('vet_nombre').value=v.nombre; $('vet_especialidad').value=v.especialidad; new bootstrap.Modal($('modalVet')).show(); }
window.delVet = async (id)=>{ if(!confirm('Eliminar veterinario?')) return; await fetchJson(API.vets+'/'+id, { method:'DELETE' }); await loadAll(); }
$('btnAddCita').addEventListener('click', ()=>{ $('cita_id').value=''; $('cita_fecha').value=''; $('cita_hora').value=''; $('cita_motivo').value=''; $('cita_especie').value=''; $('cita_cliente').value=''; $('cita_mascota').innerHTML=''; $('cita_vet').value=''; new bootstrap.Modal($('modalCita')).show(); });
$('cita_cliente').addEventListener('change', async (e)=>{ const id = e.target.value; $('cita_mascota').innerHTML = '<option value="">Cargando...</option>'; if(!id) { $('cita_mascota').innerHTML=''; $('cita_especie').value=''; return; } const pets = await fetchJson(API.mascotas+'/cliente/'+id); $('cita_mascota').innerHTML = '<option value="">Seleccione</option>' + pets.map(p=>`<option value="${p.id}" data-especie="${p.especie}">${p.nombre} (${p.especie})</option>`).join(''); });
$('cita_mascota').addEventListener('change', (e)=>{ const opt = e.target.selectedOptions[0]; $('cita_especie').value = opt ? opt.dataset.especie || '' : ''; });
$('saveCita').addEventListener('click', async ()=>{ const id = $('cita_id').value; const payload = { fecha:$('cita_fecha').value, hora:$('cita_hora').value, motivo:$('cita_motivo').value, id_mascota: $('cita_mascota').value, id_veterinario: $('cita_vet').value }; try{ if(id){ await fetchJson(API.citas+'/'+id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } else { await fetchJson(API.citas, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } new bootstrap.Modal($('modalCita')).hide(); await loadAll(); }catch(e){ alert('Error guardando cita'); } });
window.editCita = async (id)=>{ const c = window._citas.find(x=>x.id==id); if(!c) return; $('cita_id').value=c.id; $('cita_fecha').value=c.fecha; $('cita_hora').value=c.hora; $('cita_motivo').value=c.motivo; const pet = window._mascotas.find(m=>m.id==c.id_mascota) || {}; if(pet.id_cliente){ $('cita_cliente').value=pet.id_cliente; const pets = await fetchJson(API.mascotas+'/cliente/'+pet.id_cliente); $('cita_mascota').innerHTML = '<option value="">Seleccione</option>' + pets.map(p=>`<option value="${p.id}" data-especie="${p.especie}" ${p.id==c.id_mascota? 'selected':''}>${p.nombre} (${p.especie})</option>`).join(''); $('cita_especie').value = (pets.find(p=>p.id==c.id_mascota)||{}).especie || ''; } $('cita_vet').value = c.id_veterinario || ''; new bootstrap.Modal($('modalCita')).show(); };
window.delCita = async (id)=>{ if(!confirm('Eliminar cita?')) return; await fetchJson(API.citas+'/'+id, { method:'DELETE' }); await loadAll(); }
$('filtroClienteMas').addEventListener('change', async (e)=>{ const id = e.target.value; if(!id){ renderMascotas(window._mascotas); return; } const list = window._mascotas.filter(m=>m.id_cliente==id); renderMascotas(list); });
window.addEventListener('DOMContentLoaded', ()=> loadAll());
